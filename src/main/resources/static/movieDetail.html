<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Movie Details + Booking</title>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f7; }
    .movie-detail { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }

    img { width: 100%; border-radius: 10px; margin-bottom: 20px; }
    h2 { margin-bottom: 10px; }
    p { margin-bottom: 10px; }
    .info { margin-bottom: 5px; font-weight: bold; }
    span { background: #eef2ff; padding: 5px 10px; border-radius: 6px; margin-right: 5px; font-size: 12px; cursor: pointer; }

    /* Booking Section */
    .booking-section { margin-top: 30px; padding: 20px; background: #fafafa; border-radius: 10px; }
    .section-title { font-size: 20px; margin-bottom: 10px; font-weight: bold; }

    .showtime { padding: 8px 15px; background: #e6e7ff; border-radius: 6px; margin-right: 5px; cursor: pointer; }
    .showtime.selected { background: #4556ff; color: white; }

    .seats-grid { margin-top: 20px; display: grid; grid-template-columns: repeat(10, 1fr); gap: 10px; }
    .seat {
      width: 30px; height: 30px; background: #dcdcdc; border-radius: 5px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      font-size: 12px;
    }
    .seat.selected { background: #00c853; color: white; }
    .seat.booked { background: #ff1744; cursor: not-allowed; }

    .summary { margin-top: 20px; padding: 15px; background: #eef2ff; border-radius: 10px; }
    .checkout-btn {
      margin-top: 10px; padding: 10px 15px; background: #4556ff; color: white;
      border: none; border-radius: 6px; cursor: pointer; font-size: 16px;
    }
    .checkout-btn:hover { background: #3445dd; }
    
    .back-button {
      margin-top: 20px; padding: 10px 15px; background: #ddd; color: #333;
      border: none; border-radius: 6px; cursor: pointer; font-size: 16px;
    }
  </style>
</head>
<body>

<div class="movie-detail" id="movieDetail"></div>

<script>
  const movieDetailContainer = document.getElementById("movieDetail");
  const movie = JSON.parse(localStorage.getItem("selectedMovie"));
  const TICKET_PRICE = 350;
  const BOOKING_FEE = 50;

  // Check if returning from checkout with existing booking data
  const existingBooking = JSON.parse(localStorage.getItem('bookingData'));
  let selectedShowtime = existingBooking ? existingBooking.showtime : null;
  let selectedSeats = existingBooking ? existingBooking.seats : [];

  if (movie) {
    movieDetailContainer.innerHTML = `
      <img src="${movie.img}" />
      <h2>${movie.title}</h2>
      <p>${movie.desc}</p>
      <p class="info">‚≠ê Rating: ${movie.rating}</p>
      <p class="info">üé¨ Director: ${movie.director || "Unknown"}</p>
      <p class="info">üßë‚Äçü§ù‚Äçüßë Cast: ${movie.cast || "Unknown"}</p>
      <p class="info">üìÖ Release Date: ${movie.releaseDate || "TBD"}</p>
      <p class="info">‚è∞ Showtimes: ${movie.times
        .map((t) => `<span class='showtime'>${t}</span>`)
        .join("")}</p>

      <div class="booking-section">
        <div class="section-title">üéüÔ∏è Book Tickets</div>

        <p>Select Showtime:</p>
        <div id="showtimeContainer">
          ${movie.times
            .map((t) => `<span class='showtime'>${t}</span>`)
            .join("")}
        </div>

        <div id="seatArea" style="display:none;">
          <h3>üé≠ Select Your Seats</h3>
          <div class="seats-grid" id="seatsGrid"></div>
        </div>

        <div class="summary" id="summary" style="display:none;">
          <h3>üßæ Booking Summary</h3>
          <p><strong>Movie:</strong> ${movie.title}</p>
          <p><strong>Showtime:</strong> <span id="summaryTime"></span></p>
          <p><strong>Seats:</strong> <span id="summarySeats"></span></p>
          <p><strong>Ticket Price:</strong> Rs <span id="ticketPrice">${TICKET_PRICE}</span> x <span id="ticketCount">0</span></p>
          <p><strong>Booking Fee:</strong> Rs ${BOOKING_FEE}</p>
          <p><strong>Total:</strong> Rs <span id="summaryTotal">0</span></p>
          <button class="checkout-btn" onclick="checkout()">Proceed to Payment</button>
        </div>
      </div>

      <button class="back-button" onclick="goBack()">‚¨Ö Back</button>
    `;

    // Back Function
    function goBack() {
       window.location.href = '/Go-Schema-ui/home.html';
    }

    // Showtime Selection
    const showtimeButtons = document.querySelectorAll(".showtime");

    showtimeButtons.forEach((btn) => {
      // Restore previously selected showtime
      if (selectedShowtime && btn.innerText === selectedShowtime) {
        btn.classList.add("selected");
        document.getElementById("seatArea").style.display = "block";
        generateSeats();
      }

      btn.addEventListener("click", () => {
        showtimeButtons.forEach((b) => b.classList.remove("selected"));
        btn.classList.add("selected");

        selectedShowtime = btn.innerText;
        document.getElementById("seatArea").style.display = "block";
        
        // Clear seats only if changing showtime
        if (!existingBooking || existingBooking.showtime !== selectedShowtime) {
          selectedSeats = [];
        }
        
        generateSeats();
      });
    });

    // Seat Selection
    function generateSeats() {
      const seatsGrid = document.getElementById("seatsGrid");
      seatsGrid.innerHTML = "";

      for (let i = 1; i <= 80; i++) {
        const seat = document.createElement("div");
        seat.classList.add("seat");
        seat.innerText = i;

        // Restore previously selected seats
        if (selectedSeats.includes(i)) {
          seat.classList.add("selected");
        }

        seat.addEventListener("click", () => {
          if (seat.classList.contains("booked")) return;

          seat.classList.toggle("selected");

          if (seat.classList.contains("selected")) {
            if (!selectedSeats.includes(i)) {
              selectedSeats.push(i);
            }
          } else {
            selectedSeats = selectedSeats.filter((s) => s !== i);
          }

          updateSummary();
        });

        seatsGrid.appendChild(seat);
      }

      // Update summary if we have existing selections
      if (selectedSeats.length > 0) {
        updateSummary();
      }
    }

    // Update Summary
    function updateSummary() {
      const summary = document.getElementById("summary");
      summary.style.display = selectedSeats.length > 0 ? "block" : "none";

      document.getElementById("summaryTime").innerText = selectedShowtime;
      document.getElementById("summarySeats").innerText = selectedSeats.sort((a, b) => a - b).join(", ");
      document.getElementById("ticketCount").innerText = selectedSeats.length;
      
      const ticketsTotal = selectedSeats.length * TICKET_PRICE;
      const totalAmount = ticketsTotal + BOOKING_FEE;
      document.getElementById("summaryTotal").innerText = totalAmount;
    }

    // Checkout - Save booking data and redirect to checkout page
    function checkout() {
      if (!selectedShowtime) {
        alert("Please select a showtime!");
        return;
      }

      if (selectedSeats.length === 0) {
        alert("Please select at least one seat!");
        return;
      }

      // Prepare booking data
      const bookingData = {
        movie: {
          title: movie.title,
          img: movie.img,
          rating: movie.rating
        },
        showtime: selectedShowtime,
        seats: selectedSeats.sort((a, b) => a - b),
        ticketPrice: TICKET_PRICE,
        bookingFee: BOOKING_FEE
      };

      // Save to localStorage
      localStorage.setItem('bookingData', JSON.stringify(bookingData));

      // Redirect to checkout page
      window.location.href = '/Go-Schema-ui/checkout.html';
    }
  } else {
    movieDetailContainer.innerHTML = "<p>Movie not found.</p>";
  }
</script>

</body>
</html>